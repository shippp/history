# Preparing the Historical Image Dataset

## Images Preprocessing

here is a short explanation of each preprocessing methods:

### Aerial Images

The preprocessing method mainly following [Knuth et al. (2023)](https://www.sciencedirect.com/science/article/pii/S0034425722004850?via%3Dihub):

1. If RGB convert images to grayscale by using the luminance formula.
2. Detect fiducials markers at subpixel level by performing template matching
3. Outliers are rejected by removing markers that have a too low matching score.
4. Compute affine transformations to align the detected fiducials markers with calibrated fiducials markers.
5. Apply the transformation and crop the images around the center of fiducials markers and apply CLAHE.

Data preprocessing notebooks are available here:

- [casa_grande_aerial.ipynb](casa_grande_aerial.ipynb)
- [iceland_aerial.ipynb](iceland_aerial.ipynb)

### KH-9 Panoramic Camera Images

The preprocessing method mainly following :



1. **Image Joining**
    - Joins split images into a single composite image
        Requires input images named sequentially (e.g. ImageId_a, ImageId_b, ImageId_c, …)
    - A small overlap between image parts is required for proper stitching
    - Performs stitching using matched keypoints and successive affine transformations for robust, geometry-aware merging.

2. **Image Restitutions**
    - Estimates the top and bottom collimation lines using a second-degree polynomial fit.
    - Determines the vertical boundaries (x1 and x2) of the region of interest (ROI).
    - Computes the geometric transformation needed to crop and restitute the ROI using a Thin Plate Spline (TPS) deformation model.


Data preprocessing notebooks are available here:

- [casa_grande_kh9pc.ipynb](casa_grande_aerial.ipynb)
- [iceland_kh9pc.ipynb](casa_grande_aerial.ipynb)

### KH-9 Mapping Camera Images

The preprocessing method follows the method of [Dehecq et al. (2020)](https://www.frontiersin.org/journals/earth-science/articles/10.3389/feart.2020.566802/full). In brief:

1. the position of the reseau markers (dark crosses) is detected at subpixel resolution using a convolution with a cross-like kernel.
2. outliers are rejected by removing markers that are not regularly spaced (1 cm)
3. a degree 3 polynomial transformation is first applied to remove rotation and scaling, then a Thin Plate Spline interpolation is used to calculate the distortion at each pixel.
4. the two pieces are stitched together by matching the areas of overlap using NCC.
5. the image is cropped to a fix distance from the outermost markers to keep a constant image dimension among the images
6. the reseau markers are filled with inpainting.

## Auxiliary data

### `images_footprint.geojson` & `camera_model_extrinsics.csv`

The image footprints and metadata were downloaded from USGS EarthExplorer for the satellite images and Casa Grande aerial images. For the Iceland aerial images, the footprints were manually generated by Joaquin Belart, using a pre-existing, approximate location of the camera centers. In QGIS (version 3.4), using the digitizing tools, a generic, approximate footprint of one of the images, was drawn, which was then copied successively over all the camera centers. The camera extrinsics were pulled from the footprint files and converted into a CSV file.

### `camera_model_intrinsics.csv`

The camera intrinsics CSV files were filled manually based on the calibration report or information from the data provider.

### Reference DEMs

The high resolution DEMs were downloaded as raw GTiff tiles from the provider, mosaicked without resampling and the vertical datum updated (for Casa Grande only, from NAVD88 geoid to ellipsoid). The low resolution Global Copernicus 30m DEM was downloaded as raw GTiff tiles from OpenTopography, reprojected on the same horizontal CRS as the high-res DEM and converted from original EGM2008 heights to ellipsoid heights. It was then coregistered to the high-res DEM by applying a horizontal and vertical shift, calculated using xDEM’s implementation of the Nuth & Kääb (2011) algorithm. Pixels outside the “stable mask” (see below) are excluded during coregistration.

### Stable mask

The ESA worldcover raw GTiff tiles were downloaded and mosaicked, and reprojected on the same CRS and grid as the two reference DEMs. Anything but shrubland, grassland, bare/sparse vegetation, moss/lichen (respective values of 20, 30, 60 and 100) are masked as unstable. For Iceland, the Randolph glacier inventory (RGI) v7 outlines were rasterized to the DEM grids and masked. For Casa Grande, the subsidence mask was rasterized to the DEM grids and masked. The DEM and stable mask processing scripts are located at https://github.com/shippp/history/tree/main/src/history/aux_data (yet to be added to the repo as of 3 July 2025).

### Ground Control Points - `gcp.csv`

GCPs are provided only for the aerial dataset. They have been manually picked by Joaquin Belart using the data provided in this experiment, as well as the orthomosaic from Bing Maps in QGIS (©Microsoft, data accessible in QGIS via XYZ tiles using http://ecn.t3.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1). For picking of GCPs, the QGIS plugin “Coordinate capturer” was used. This allows extracting pixel coordinates of the aerial photographs (rows and columns), as well as geographical coordinates of the reference data (longitude and latitude). The measurements were gathered into an ASCII list. Then, the elevation values were extracted from the reference DEM using the command geodiff in the Ames StereoPipeline software (version 3.6, Beyer et al., 2018).